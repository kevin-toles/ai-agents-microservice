name: Protocol Integration Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/a2a/**'
      - 'src/mcp/**'
      - 'src/config/feature_flags.py'
      - 'tests/e2e/**'
      - 'tests/unit/a2a/**'
      - 'tests/unit/mcp/**'
      - 'tests/integration/test_mcp_*.py'
      - 'tests/integration/test_a2a_*.py'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/a2a/**'
      - 'src/mcp/**'
      - 'src/config/feature_flags.py'
      - 'tests/e2e/**'
      - 'tests/unit/a2a/**'
      - 'tests/unit/mcp/**'

env:
  PYTHON_VERSION: '3.13'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run feature flag tests
        run: |
          pytest tests/unit/config/test_feature_flags.py -v --tb=short
      
      - name: Run A2A unit tests
        run: |
          pytest tests/unit/a2a/ -v --tb=short
      
      - name: Run MCP unit tests
        run: |
          pytest tests/unit/mcp/ -v --tb=short

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run MCP integration tests
        run: |
          pytest tests/integration/test_mcp_*.py -v --tb=short
      
      - name: Run Phase 1 unchanged tests
        run: |
          pytest tests/integration/test_phase1_unchanged.py -v --tb=short

  e2e-tests-disabled:
    name: E2E Tests (All Disabled)
    runs-on: ubuntu-latest
    needs: integration-tests
    
    env:
      AGENTS_A2A_ENABLED: 'false'
      AGENTS_MCP_ENABLED: 'false'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run E2E tests (disabled state)
        run: |
          pytest tests/e2e/test_feature_flags.py -v --tb=short

  e2e-tests-enabled:
    name: E2E Tests (All Enabled)
    runs-on: ubuntu-latest
    needs: integration-tests
    
    env:
      AGENTS_A2A_ENABLED: 'true'
      AGENTS_A2A_AGENT_CARD_ENABLED: 'true'
      AGENTS_A2A_TASK_LIFECYCLE_ENABLED: 'true'
      AGENTS_A2A_STREAMING_ENABLED: 'true'
      AGENTS_MCP_ENABLED: 'true'
      AGENTS_MCP_SERVER_ENABLED: 'true'
      AGENTS_MCP_CLIENT_ENABLED: 'true'
      AGENTS_MCP_SEMANTIC_SEARCH: 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run E2E tests (enabled state)
        run: |
          pytest tests/e2e/test_a2a_schema.py -v --tb=short
      
      - name: Run feature flag matrix tests
        run: |
          pytest tests/e2e/test_feature_flags.py -v --tb=short

  rollback-verification:
    name: Rollback Verification
    runs-on: ubuntu-latest
    needs: [e2e-tests-disabled, e2e-tests-enabled]
    
    env:
      AGENTS_A2A_ENABLED: 'false'
      AGENTS_MCP_ENABLED: 'false'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Start service in background
        run: |
          uvicorn src.main:app --host 0.0.0.0 --port 8082 &
          sleep 5
      
      - name: Run rollback verification
        run: |
          python scripts/verify_rollback.py --base-url http://localhost:8082

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run tests with coverage
        run: |
          pytest tests/unit/config/test_feature_flags.py \
                 tests/unit/a2a/ \
                 tests/unit/mcp/ \
                 tests/integration/test_mcp_*.py \
                 tests/integration/test_phase1_unchanged.py \
                 --cov=src/a2a --cov=src/mcp --cov=src/config/feature_flags \
                 --cov-report=xml \
                 --cov-report=term-missing
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: protocol-integration
          name: protocol-integration-coverage
